<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Gemini & Nano Banana Prompt Collection</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        },
                        blue: {
                            600: '#2563EB',
                            700: '#1D4ED8',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    
    <!-- FileSaver untuk download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937;
        }

        /* Copy Icon Animation */
        .copy-btn:active {
            transform: scale(0.95);
        }
        
        /* Custom Scrollbar for image gallery horizontal scroll if needed */
        .gallery-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .gallery-scroll::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }
        
        /* Animation for items when loading */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 md:px-8">

    <!-- Kontainer utama -->
    <div class="max-w-4xl mx-auto bg-white min-h-[90vh] shadow-sm border border-gray-200 rounded-xl">
        
        <!-- HEADER SECTION - Ditambahkan sticky, top-0, z-10, dan backdrop-blur untuk efek buram saat menggulir -->
        <div class="bg-gray-100/90 p-8 border-b border-gray-200 sticky top-0 z-10 backdrop-blur-sm">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight mb-6">
                Ultimate Gemini & Nano Banana Prompt Collection
            </h1>
            
            <!-- Search Box and Clear Button -->
            <div class="flex gap-4">
                <div class="relative flex-1">
                    <input type="text" id="search-input" 
                        class="w-full bg-gray-200 border-none rounded-lg py-3 pl-5 pr-12 text-gray-700 placeholder-gray-500 focus:ring-2 focus:ring-blue-600 focus:bg-white transition outline-none"
                        placeholder="Cari prompt..."
                        title="Tekan Enter untuk mencari di database.">
                    <!-- Search Icon -->
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                
                <!-- Clear Search Button -->
                <button id="clear-search-btn" onclick="clearSearch()" 
                    class="px-5 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150 flex items-center justify-center font-semibold text-sm w-full sm:w-auto"
                    title="Hapus filter pencarian dan kembali ke daftar normal.">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    Reset
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT LIST -->
        <div id="prompt-list-container" class="p-8 space-y-12">
            <!-- Prompt Items will be injected here -->
            <p class="text-center text-gray-400 py-10">Memuat data dari Cloudflare Worker...</p>
        </div>

        <!-- Loading & Status -->
        <div id="loading-indicator" class="hidden py-8 text-center text-gray-500">
            <span class="inline-flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Memuat data...
            </span>
        </div>
        
        <div id="observer-target" class="h-4 w-full"></div> 
        <p id="end-message" class="hidden text-center text-gray-400 text-sm py-8 border-t border-gray-100">--- Akhir dari Koleksi ---</p>

    </div>

    <!-- MODAL PREVIEW GAMBAR (Simple Light Theme) -->
    <div id="preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="relative max-w-5xl w-full bg-transparent flex flex-col items-center">
            <button onclick="closePreviewModal()" class="absolute -top-12 right-0 text-white hover:text-gray-300 transition">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="preview-image" src="" alt="Full Preview" class="max-h-[85vh] rounded shadow-2xl object-contain">
            <a id="download-full-btn" href="#" download class="mt-4 px-6 py-2 bg-white text-gray-900 rounded-full font-medium hover:bg-gray-100 transition shadow-lg">
                Download Gambar
            </a>
        </div>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="message-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- JAVASCRIPT -->
    <script>
        // =========================================================================
        // PENTING: KONFIGURASI WORKER API
        // Ganti URL ini dengan URL Cloudflare Worker Anda (misalnya: https://nama-worker.user.workers.dev)
        // Jika Anda menggunakan Pages Redirects, cukup gunakan '/api/prompts'
        // Jika tidak, gunakan URL lengkap Worker Anda.
        //const WORKER_API_ENDPOINT = '/api/prompts'; // Gunakan ini jika Pages Redirects dikonfigurasi.
        //const WORKER_API_ENDPOINT = 'https://[nama-worker].[user].workers.dev/api/prompts'; // Gunakan ini jika tidak ada Redirects.
        
        
        const WORKER_API_ENDPOINT = 'https://sampletask.helenaliuw.workers.dev/prompts';

        // --- STATE ---
        const PAGE_SIZE = 2; 
        let loadedCount = 0;
        let isLoading = false;
        let hasMore = true;
        let allPromptsData = []; 
        let isSearching = false; 
        
        // --- DOM ELEMENTS ---
        const promptListContainer = document.getElementById('prompt-list-container');
        const searchInput = document.getElementById('search-input'); 

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        window.onload = () => {
            // Kita tidak perlu inisialisasi Supabase di sini lagi!
            setupIntersectionObserver();
            // Event listener untuk tombol ENTER pada input pencarian
            searchInput.addEventListener('keydown', handleSearchKeydown); 
            
            // Load Data
            loadPrompts(); 
        };

        // =========================================================================
        // SEARCH AND FILTER LOGIC (MENGGUNAKAN WORKER)
        // =========================================================================
        
        /**
         * Menangani penekanan tombol pada input pencarian. Memicu pencarian jika tombol Enter ditekan.
         * @param {KeyboardEvent} event 
         */
        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                const query = searchInput.value;
                searchPromptsInDatabase(query);
            }
        }
        
        /**
         * Melakukan pencarian data dengan memanggil Worker.
         * @param {string} query - Kata kunci pencarian.
         */
        async function searchPromptsInDatabase(query) {
            const term = query.toLowerCase().trim();
            if (term === '') {
                clearSearch();
                return;
            }

            // Masuk mode pencarian
            isSearching = true;
            promptListContainer.innerHTML = '';
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('observer-target').classList.add('hidden'); // Matikan infinite scroll
            document.getElementById('end-message').classList.add('hidden');

            try {
                // Panggil Worker dengan parameter query
                const url = `${WORKER_API_ENDPOINT}?query=${encodeURIComponent(term)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Terjadi kesalahan saat mencari.');
                }

                allPromptsData = data; 
                renderAllPrompts();
                
                if (data.length === 0) {
                     promptListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">Tidak ditemukan prompt yang cocok dengan kata kunci: "${term}".</p>`;
                } 
                
                // Tampilkan pesan hasil pencarian dan matikan infinite scroll secara permanen
                document.getElementById('end-message').classList.remove('hidden'); 
                document.getElementById('end-message').textContent = `--- Ditemukan ${data.length} hasil untuk "${term}" ---`;

            } catch (err) {
                console.error('Database Search Error:', err);
                displayMessage(`Gagal melakukan pencarian: ${err.message}`, 'error');
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }
        
        /**
         * Mereset status aplikasi kembali ke mode infinite scroll default.
         */
        window.clearSearch = function() {
            if (!isSearching && allPromptsData.length > 0) {
                displayMessage('Tidak ada filter pencarian aktif.', 'info');
                return;
            }
            
            searchInput.value = '';
            isSearching = false;
            loadedCount = 0; // Reset pagination
            hasMore = true; // Aktifkan infinite scroll
            allPromptsData = []; // Kosongkan data
            promptListContainer.innerHTML = '';
            document.getElementById('end-message').textContent = '--- Akhir dari Koleksi ---';
            document.getElementById('end-message').classList.add('hidden');
            document.getElementById('observer-target').classList.remove('hidden'); // Aktifkan observer

            loadPrompts(); // Muat ulang data awal
            displayMessage('Filter pencarian dihapus. Memuat data awal...', 'info');
        }


        // =========================================================================
        // DATA FETCHING (INFINITE SCROLL MENGGUNAKAN WORKER)
        // =========================================================================
        async function loadPrompts() {
            // Hentikan eksekusi jika sedang memuat, tidak ada lagi data, atau sedang dalam mode pencarian
            if (isLoading || !hasMore || isSearching) return;
            
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');

            const from = loadedCount;
            const to = loadedCount + PAGE_SIZE - 1; 

            try {
                // Panggil Worker dengan parameter range/pagination
                const url = `${WORKER_API_ENDPOINT}?from=${from}&to=${to}`;
                const response = await fetch(url);
                const prompts = await response.json(); 

                if (!response.ok) {
                    throw new Error(prompts.error || 'Gagal mengambil data dari worker.');
                }

                if (prompts.length === 0 && loadedCount === 0) {
                     // Jika tidak ada data sama sekali
                     promptListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">Belum ada prompt dalam koleksi.</p>`;
                     hasMore = false;
                } else if (prompts.length === 0) {
                    hasMore = false;
                    document.getElementById('end-message').classList.remove('hidden');
                } else {
                    // Hanya bersihkan kontainer jika ini adalah pemuatan awal (loadedCount === 0)
                    if (loadedCount === 0) {
                        promptListContainer.innerHTML = '';
                    }

                    // Gabungkan data baru ke data global dan render
                    prompts.forEach(prompt => {
                        if (!allPromptsData.some(p => p.id === prompt.id)) {
                             allPromptsData.push(prompt); 
                             // Hanya tambahkan yang baru ke DOM
                             promptListContainer.insertAdjacentHTML('beforeend', getPromptItemHtml(prompt));
                        }
                    });
                    
                    loadedCount += prompts.length;
                    if (prompts.length < PAGE_SIZE) { 
                        hasMore = false;
                        document.getElementById('end-message').classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error('Load Prompts Error:', err);
                displayMessage(`Gagal memuat daftar prompt: ${err.message}`, 'error');
            } finally {
                isLoading = false;
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        // =========================================================================
        // RENDERING UI
        // =========================================================================
        // Fungsi rendering tetap sama, hanya memproses data yang sudah ada di allPromptsData.
        function renderAllPrompts() {
            // Bersihkan kontainer jika ini adalah inisialisasi atau pencarian baru
            if (loadedCount === 0 || isSearching) {
                promptListContainer.innerHTML = ''; 
            }
            
            if (allPromptsData.length === 0 && searchInput.value.trim() !== '' && isSearching) {
                // Pesan 'Tidak ditemukan hasil' sudah ditangani di searchPromptsInDatabase
                return;
            } else if (allPromptsData.length === 0) {
                 promptListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">Belum ada prompt dalam koleksi.</p>`;
                 return;
            }

            allPromptsData.forEach(prompt => {
                // Periksa apakah prompt sudah ada di DOM sebelum menyisipkan (untuk mencegah duplikasi saat infinite scroll)
                if (!document.getElementById(`prompt-${prompt.id}`)) {
                    promptListContainer.insertAdjacentHTML('beforeend', getPromptItemHtml(prompt));
                }
            });
        }
        
        function getPromptItemHtml(prompt) {
            const title = prompt.title || 'Untitled';
            // Format tanggal: "02 Des 2025 03:15:12"
            const date = new Date(prompt.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit', second: '2-digit' }).replace(/\./g, ':'); 
            const images = prompt.images || [];
            
            // Tags processing
            const tagsString = prompt.tags || '';
            const tags = tagsString.split(',').map(t => t.trim()).filter(t => t.length > 0);
            // Tombol tag sekarang memicu pencarian DB
            const tagsHtml = tags.map(tag => `<span class="mr-2 cursor-pointer hover:text-blue-600 hover:underline" onclick="searchPromptsInDatabase('${tag}'); searchInput.value = '${tag}'; window.scrollTo(0,0);">#${tag}</span>`).join('');

            // Escaping content for JS safety
            const escapedContent = prompt.content.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n');

            return `
                <div id="prompt-${prompt.id}" class="group border-b border-gray-100 pb-8 last:border-0 animate-fade-in">
                    <!-- Title -->
                    <h2 class="text-2xl font-bold text-gray-900 mb-1 leading-tight">${title}</h2>
                    
                    <!-- Date -->
                    <p class="text-sm text-gray-500 mb-2">${date}</p>
                    
                    <!-- Tags -->
                    <div class="text-sm text-gray-600 font-medium mb-4">
                        ${tagsHtml}
                    </div>
                    
                    <!-- Prompt Content with Copy Icon -->
                    <div class="flex items-start gap-3 mb-6">
                        <button onclick="copyPromptText('${escapedContent}')" 
                            class="copy-btn mt-1 flex-shrink-0 text-gray-400 hover:text-blue-600 transition" 
                            title="Salin Prompt">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        
                        <p class="text-gray-800 leading-relaxed text-base select-text whitespace-pre-wrap font-normal">${prompt.content}</p>
                    </div>

                    <!-- Images Grid -->
                    <div class="flex flex-wrap gap-4">
                        ${images.map(img => `
                            <div class="relative group/img overflow-hidden rounded-lg shadow-sm border border-gray-200 w-32 h-32 md:w-40 md:h-40 bg-gray-50 cursor-zoom-in"
                                 onclick="openPreviewModal('${img.public_url}', '${img.filename}')">
                                <img src="${img.public_thumb_url || img.public_url}" 
                                     class="w-full h-full object-cover transition duration-300 group-hover/img:scale-105"
                                     loading="lazy"
                                     alt="Prompt Image">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // =========================================================================
        // UTILS
        // =========================================================================
        
        // Copy Function
        function copyPromptText(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            displayMessage('Prompt disalin ke clipboard!', 'success');
        }

        // Toast Message
        function displayMessage(msg, type) {
            const container = document.getElementById('message-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium text-sm animate-bounce-in pointer-events-auto ${type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-600' : 'bg-gray-800')}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Modal Logic
        const modal = document.getElementById('preview-modal');
        const modalImg = document.getElementById('preview-image');
        const downloadBtn = document.getElementById('download-full-btn');

        function openPreviewModal(url, filename) {
            modalImg.src = url;
            downloadBtn.href = url;
            downloadBtn.download = filename;
            modal.classList.remove('hidden');
        }

        function closePreviewModal() {
            modal.classList.add('hidden');
            modalImg.src = '';
        }
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closePreviewModal();
        });

        // Intersection Observer for Infinite Scroll
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                // Hanya muat data jika tidak sedang mencari
                if (entries[0].isIntersecting && hasMore && !isLoading && !isSearching) {
                    loadPrompts();
                }
            }, { rootMargin: '200px' });
            observer.observe(document.getElementById('observer-target'));
        }
    </script>
</body>
</html>
